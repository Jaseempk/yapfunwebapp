FROM node:18-alpine

# Add ARG instructions to receive environment variables during build
ARG REDIS_URL
ARG NODE_ENV
ARG PORT
ARG RPC_URL
ARG WEBSOCKET_PATH
ARG KAITO_API_URL
ARG DEPLOYER_PRIVATE_KEY
ARG ORDERBOOK_SUBGRAPH_URL
ARG ORACLE_SUBGRAPH_URL
ARG FACTORY_SUBGRAPH_URL
ARG SUPABASE_URL
ARG SUPABASE_KEY

# Set them as environment variables
ENV REDIS_URL=${REDIS_URL}
ENV NODE_ENV=${NODE_ENV}
ENV PORT=${PORT}
ENV RPC_URL=${RPC_URL}
ENV WEBSOCKET_PATH=${WEBSOCKET_PATH}
ENV KAITO_API_URL=${KAITO_API_URL}
ENV DEPLOYER_PRIVATE_KEY=${DEPLOYER_PRIVATE_KEY}
ENV ORDERBOOK_SUBGRAPH_URL=${ORDERBOOK_SUBGRAPH_URL}
ENV ORACLE_SUBGRAPH_URL=${ORACLE_SUBGRAPH_URL}
ENV FACTORY_SUBGRAPH_URL=${FACTORY_SUBGRAPH_URL}
ENV SUPABASE_URL=${SUPABASE_URL}
ENV SUPABASE_KEY=${SUPABASE_KEY}

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# Build with TypeScript
RUN npm run build || (echo "Build failed. Check TypeScript errors above." && exit 1)

EXPOSE 4000

CMD ["npm", "start"]
